# Capsule Kit v3.0 - Best Practices

Guidelines for getting the most value from Capsule Kit's automatic context system and tool ecosystem.

---

## How Context Works Now

Capsule Kit v3.0 uses **Capsule** (SQLite) with automatic JS hooks. There is **no manual logging** — everything is captured automatically:

- **File operations** → Captured by `post-tool-use.js` as META records
- **Sub-agent results** → Captured by `post-tool-use.js` as SUMMARY records
- **Session summaries** → Created by `session-end.js`
- **Context injection** → Handled by `session-start.js` at session start

---

## Required Behaviors

### High Priority

#### Use Specialized Tools (Not Task/Explore)

**Why**: Specialized tools use pre-built graphs — instant vs sequential scanning.

```bash
# Dependency analysis
bash $HOME/.claude/cck/tools/query-deps/query-deps.sh <file>        # What imports this?
bash $HOME/.claude/cck/tools/impact-analysis/impact-analysis.sh <file>  # What breaks?
bash $HOME/.claude/cck/tools/find-circular/find-circular.sh          # Circular deps?
bash $HOME/.claude/cck/tools/find-dead-code/find-dead-code.sh        # Dead code?

# File/code search
Glob(pattern="**/*auth*")           # Find files
Grep(pattern="function.*login")     # Find code
```

**Never** use Task/Explore for dependency queries, file search, or code search.

---

#### Use Progressive-Reader for Large Files

**Why**: Files >50KB waste tokens and may fail to read.

```bash
# Step 1: Discover structure
$HOME/.claude/bin/progressive-reader --path <file> --list

# Step 2: Read specific chunk
$HOME/.claude/bin/progressive-reader --path <file> --chunk N

# 75-97% token savings
```

If you get `MaxFileReadTokenExceededError`, **immediately** switch to progressive-reader.

---

#### Spawn Agents in Parallel

**Why**: Sequential spawning wastes time — parallel is 3x faster.

```
# DON'T (sequential, 3 messages):
Message 1: Task(subagent_type="error-detective", ...)
Message 2: Task(subagent_type="architecture-explorer", ...)

# DO (parallel, 1 message):
Task(subagent_type="error-detective", ...)
Task(subagent_type="architecture-explorer", ...)
```

---

#### Avoid Duplicate Sub-Agent Work

**Why**: Context from session-start shows previous agent findings.

```
# Session-start.js injects recent sub-agent results
# Check injected context before re-launching the same agent type
# Only re-run if context has changed significantly
```

---

### Medium Priority

#### Use the Right Agent for the Job

| Task | Agent |
|------|-------|
| Error root cause | `error-detective` |
| Systematic debugging | `debugger` |
| Code quality review | `code-reviewer` |
| Safe refactoring | `refactoring-specialist` |
| How does X work? | `architecture-explorer` |
| Database schema | `database-navigator` |
| Security analysis | `security-engineer` |
| Git operations | `git-workflow-manager` |
| Production issues | `devops-sre` |
| Design decisions | `brainstorm-coordinator` |

17 agents available. All are **read-only** (no Edit/Write/Bash).

---

## Forbidden Behaviors

### Critical

#### NEVER Use Task/Explore for Dependencies or Search

**Problem**: 10x slower than specialized tools.

```bash
# BAD:
Task(subagent_type="Explore", prompt="Find what imports auth.ts")

# GOOD:
bash $HOME/.claude/cck/tools/query-deps/query-deps.sh src/auth/auth.ts
# Instant result from pre-built graph
```

---

### High Priority

#### DON'T Debug by Guessing

**Problem**: Complex bugs need RCA, not trial-and-error.

```
# BAD:
[Read files, guess causes, try random fixes]

# GOOD:
Task(subagent_type="error-detective", prompt="RCA for [error]")
# Get root cause analysis, then fix
```

---

#### DON'T Create Files in .claude/

**Problem**: `.claude/` is generated by install. Source files go in `tools/`, `hooks/`, `scripts/`.

```bash
# BAD:
.claude/tools/my-new-tool/  # Will be overwritten on install

# GOOD:
tools/my-new-tool/          # Source location, committed to git
```

---

## Integration with Skills

Skills enforce best practices automatically:

| Best Practice | Skill |
|---------------|-------|
| Systematic multi-step tasks | `/workflow` |
| RCA-first debugging | `/debug` |
| Build codebase understanding | `/deep-context` |
| Pre-commit quality gate | `/code-review` |

**Recommendation**: Use skills for complex work — they guide you through the right process.

---

## Success Metrics

### Good Usage Looks Like:

- Specialized tools for deps/search (not Task/Explore)
- Parallel agent spawning (not sequential)
- Progressive-reader for large files (not raw Read)
- Right agent for the job (error-detective for errors, not general exploration)
- Context builds automatically across sessions

### Warning Signs:

- Using Task/Explore for dependency queries
- Sequential agent spawning
- Re-reading large files multiple times
- Not using skills for complex tasks
- Creating files in `.claude/` directory

---

**Remember**: Capsule Kit v3.0 is automatic. Focus on using the right tools and agents — Capsule handles the memory.
